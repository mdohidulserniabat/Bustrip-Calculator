<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Bus Trip Hisab By Md Ohidul</title>
<!-- Excel Export Library -->
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- PDF Export Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
  :root {
    --primary: #1976d2;
    --primary-dark: #0d47a1;
    --secondary: #f57c00;
    --success: #388e3c;
    --danger: #d32f2f;
    --purple: #7b1fa2;
    --light-bg: #eef2f5;
    --card-bg: #ffffff;
    --text: #222222;
    --text-light: #666666;
    --border: #e0e0e0;
    --shadow: 0 10px 30px rgba(0,0,0,0.08);
    --shadow-hover: 0 15px 35px rgba(0,0,0,0.12);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 1300px;
    margin: 0 auto;
  }

  .header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 25px 30px;
    border-radius: 20px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }

  .header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 200px;
    height: 200px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    transform: translate(30%, -30%);
  }

  .header h1 {
    margin: 0;
    font-size: 28px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .header h1 i {
    font-size: 32px;
  }

  .header .subtitle {
    margin-top: 8px;
    opacity: 0.9;
    font-size: 16px;
  }

  .card {
    background: var(--card-bg);
    border-radius: 18px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }

  .stat-card {
    padding: 25px;
    border-radius: 16px;
    position: relative;
    overflow: hidden;
    color: white;
    transition: all 0.3s ease;
  }

  .stat-card:hover {
    transform: scale(1.03);
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
  }

  .stat-card.jor {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
  }

  .stat-card.bijor {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  }

  .stat-card.today {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
  }

  .stat-card.all {
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
  }

  .stat-card .label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .stat-card .value {
    font-size: 32px;
    font-weight: 800;
    margin: 0;
  }

  .stat-card .icon {
    position: absolute;
    bottom: 15px;
    right: 20px;
    font-size: 45px;
    opacity: 0.2;
  }

  .date-selector {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
    padding: 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 16px;
    border: 1px solid var(--border);
  }

  .date-selector label {
    font-weight: 600;
    color: var(--text);
    font-size: 16px;
  }

  .date-selector input[type="date"] {
    padding: 12px 18px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 16px;
    font-family: inherit;
    background: white;
    color: var(--text);
    transition: all 0.3s ease;
  }

  .date-selector input[type="date"]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
  }

  .date-display {
    margin-left: auto;
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
    padding: 10px 20px;
    background: rgba(25, 118, 210, 0.1);
    border-radius: 12px;
    min-width: 300px;
    text-align: center;
  }

  .trip-lists {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    margin-bottom: 25px;
  }

  @media (max-width: 900px) {
    .trip-lists {
      grid-template-columns: 1fr;
    }
  }

  .list-container {
    background: white;
    border-radius: 16px;
    padding: 0;
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .list-header {
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 15px;
  }

  .list-header h3 {
    margin: 0;
    font-size: 20px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .list-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .trip-list {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
  }

  .trip-list::-webkit-scrollbar {
    width: 8px;
  }

  .trip-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }

  .trip-list::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 4px;
  }

  .trip-item {
    padding: 15px;
    margin-bottom: 12px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.3s ease;
  }

  .trip-item:hover {
    transform: translateX(5px);
    border-color: var(--primary);
    box-shadow: 0 5px 15px rgba(25, 118, 210, 0.1);
  }

  .trip-code {
    font-family: 'Courier New', monospace;
    font-weight: 700;
    font-size: 16px;
    color: var(--primary);
    padding: 5px 12px;
    background: rgba(25, 118, 210, 0.08);
    border-radius: 8px;
    border: 1px solid rgba(25, 118, 210, 0.2);
  }

  .serial-number {
    color: var(--text-light);
    font-weight: 600;
    min-width: 40px;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-light);
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.3;
  }

  .empty-state p {
    margin: 0;
    font-size: 16px;
  }

  button {
    padding: 12px 24px;
    border-radius: 12px;
    border: none;
    font-family: inherit;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: 44px;
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }

  button:active {
    transform: translateY(0);
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
  }

  .btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
  }

  .btn-success {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    color: white;
  }

  .btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
  }

  .btn-warning {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
  }

  .btn-purple {
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
    color: white;
  }

  .btn-excel {
    background: linear-gradient(135deg, #217346 0%, #1a5d38 100%);
    color: white;
  }

  .btn-pdf {
    background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
    color: white;
  }

  .btn-small {
    padding: 8px 16px;
    font-size: 14px;
    min-height: 36px;
  }

  .action-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    padding: 25px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 16px;
    border: 1px solid var(--border);
  }

  .input-section {
    padding: 25px;
    background: white;
    border-radius: 16px;
    border: 1px solid var(--border);
  }

  .input-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: var(--text);
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  textarea, input[type="text"] {
    width: 100%;
    padding: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 16px;
    font-family: inherit;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    resize: vertical;
  }

  textarea:focus, input[type="text"]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
  }

  textarea {
    min-height: 150px;
  }

  .input-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .note {
    font-size: 14px;
    color: var(--text-light);
    margin-top: 15px;
    padding: 15px;
    background: rgba(25, 118, 210, 0.05);
    border-radius: 12px;
    border-left: 4px solid var(--primary);
  }

  .status-box {
    padding: 15px 20px;
    border-radius: 12px;
    margin: 15px 0;
    display: none;
    animation: slideIn 0.3s ease;
  }

  .status-box.success {
    background: rgba(76, 175, 80, 0.1);
    color: #2e7d32;
    border-left: 4px solid #4caf50;
  }

  .status-box.error {
    background: rgba(211, 47, 47, 0.1);
    color: #b71c1c;
    border-left: 4px solid #d32f2f;
  }

  .status-box.info {
    background: rgba(25, 118, 210, 0.1);
    color: #0d47a1;
    border-left: 4px solid #1976d2;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .export-section {
    padding: 25px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 16px;
    border: 1px solid var(--border);
    margin-bottom: 25px;
  }

  .export-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: var(--text);
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .export-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }

  .export-card {
    padding: 25px;
    background: white;
    border-radius: 16px;
    border: 1px solid var(--border);
    transition: all 0.3s ease;
  }

  .export-card:hover {
    transform: translateY(-5px);
    border-color: var(--primary);
    box-shadow: 0 10px 25px rgba(25, 118, 210, 0.1);
  }

  .export-card h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .export-card p {
    margin: 0 0 20px 0;
    color: var(--text-light);
    font-size: 14px;
    line-height: 1.6;
  }

  .export-features {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
  }

  .feature-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    color: var(--text);
  }

  .feature-item i {
    color: var(--success);
  }

  .badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
  }

  .badge-new {
    background: linear-gradient(135deg, #ff4081 0%, #f50057 100%);
    color: white;
  }

  .badge-popular {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
  }

  .icon {
    font-size: 24px;
  }

  .hidden {
    display: none;
  }

  @media (max-width: 768px) {
    .container {
      padding: 10px;
    }
    
    .header {
      padding: 20px;
    }
    
    .header h1 {
      font-size: 24px;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
    }
    
    .date-display {
      min-width: auto;
      width: 100%;
      margin-top: 15px;
      margin-left: 0;
    }
    
    .export-options {
      grid-template-columns: 1fr;
    }
    
    button {
      width: 100%;
      justify-content: center;
    }
    
    .input-actions {
      flex-direction: column;
    }
    
    .action-buttons {
      flex-direction: column;
    }
  }
</style>
<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
  <div class="header">
    <h1><i class="fas fa-bus"></i> Bus Trip Hisab By Md Ohidul Islam</h1>
    <div class="subtitle">Professional Bus Trip Management System with Excel & PDF Export</div>
  </div>

  <div class="stats-grid">
    <div class="stat-card jor">
      <div class="label"><i class="fas fa-list-ol"></i> Jor Trips</div>
      <div class="value" id="jorCount">0</div>
      <div class="icon"><i class="fas fa-bus"></i></div>
    </div>
    <div class="stat-card bijor">
      <div class="label"><i class="fas fa-list-ul"></i> Bijor Trips</div>
      <div class="value" id="bijorCount">0</div>
      <div class="icon"><i class="fas fa-bus-alt"></i></div>
    </div>
    <div class="stat-card today">
      <div class="label"><i class="fas fa-calendar-day"></i> Total (This Date)</div>
      <div class="value" id="totalCount">0</div>
      <div class="icon"><i class="fas fa-chart-line"></i></div>
    </div>
    <div class="stat-card all">
      <div class="label"><i class="fas fa-chart-bar"></i> All Time Total</div>
      <div class="value" id="allTimeCount">0</div>
      <div class="icon"><i class="fas fa-database"></i></div>
    </div>
  </div>

  <div class="card date-selector">
    <label for="datePicker"><i class="fas fa-calendar-alt"></i> Selected Date:</label>
    <input type="date" id="datePicker" />
    <button onclick="goToToday()" class="btn-primary btn-small"><i class="fas fa-calendar-check"></i> Today</button>
    <div class="date-display" id="currentDateDisplay"></div>
  </div>

  <div id="statusBox" class="status-box"></div>

  <div class="export-section">
    <h3><i class="fas fa-file-export"></i> Export Reports</h3>
    <div class="export-options">
      <div class="export-card">
        <h4><i class="fas fa-file-excel"></i> Export to Excel <span class="badge badge-popular">Popular</span></h4>
        <p>Export your trip data to Microsoft Excel format (.xlsx) with professional formatting and styling.</p>
        <div class="export-features">
          <div class="feature-item"><i class="fas fa-check-circle"></i> Serial numbers for all trips</div>
          <div class="feature-item"><i class="fas fa-check-circle"></i> Separate columns for Jor & Bijor</div>
          <div class="feature-item"><i class="fas fa-check-circle"></i> Automatic formatting and styling</div>
          <div class="feature-item"><i class="fas fa-check-circle"></i> Date-wise trip categorization</div>
        </div>
        <button onclick="exportToExcel()" class="btn-excel"><i class="fas fa-file-excel"></i> Export to Excel</button>
      </div>
      <div class="export-card">
        <h4><i class="fas fa-file-pdf"></i> Export to PDF <span class="badge badge-new">New</span></h4>
        <p>Generate a professional PDF report with your trip data, perfect for printing and sharing.</p>
        <div class="export-features">
          <div class="feature-item"><i class="fas fa-check-circle"></i> Professional layout design</div>
          <div class="feature-item"><i class="fas fa-check-circle"></i> Serial numbers included</div>
          <div class="feature-item"><i class="fas fa-check-circle"></i> Color-coded trip categories</div>
          <div class="feature-item"><i class="fas fa-check-circle"></i> Summary statistics</div>
        </div>
        <button onclick="exportToPDF()" class="btn-pdf"><i class="fas fa-file-pdf"></i> Export to PDF</button>
      </div>
    </div>
  </div>

  <div class="trip-lists">
    <div class="list-container">
      <div class="list-header">
        <h3><i class="fas fa-bus" style="color: #1976d2;"></i> Jor Trips</h3>
        <div class="list-actions">
          <button onclick="copyList('jor')" class="btn-primary btn-small"><i class="fas fa-copy"></i> Copy Jor</button>
          <button onclick="clearList('jor')" class="btn-danger btn-small"><i class="fas fa-trash"></i> Clear Jor</button>
        </div>
      </div>
      <div class="trip-list" id="jorList">
        <!-- Jor trips will be loaded here -->
      </div>
    </div>

    <div class="list-container">
      <div class="list-header">
        <h3><i class="fas fa-bus-alt" style="color: #f57c00;"></i> Bijor Trips</h3>
        <div class="list-actions">
          <button onclick="copyList('bijor')" class="btn-warning btn-small"><i class="fas fa-copy"></i> Copy Bijor</button>
          <button onclick="clearList('bijor')" class="btn-danger btn-small"><i class="fas fa-trash"></i> Clear Bijor</button>
        </div>
      </div>
      <div class="trip-list" id="bijorList">
        <!-- Bijor trips will be loaded here -->
      </div>
    </div>
  </div>

  <div class="action-buttons">
    <button onclick="copyAll()" class="btn-success"><i class="fas fa-copy"></i> Copy Jor + Bijor</button>
    <button onclick="clearCurrentDate()" class="btn-danger"><i class="fas fa-calendar-times"></i> Clear Current Date</button>
    <button onclick="clearAllData()" class="btn-danger"><i class="fas fa-database"></i> Clear ALL Data</button>
  </div>

  <div class="input-section">
    <h3><i class="fas fa-paste"></i> Paste Bulk Text</h3>
    <textarea id="bulk" rows="8" placeholder="Paste the full page content here (your sample format) ..."></textarea>
    <div class="input-actions">
      <button onclick="processBulk()" class="btn-primary"><i class="fas fa-cogs"></i> Process Bulk (coach-only, omit Seats ≥34)</button>
      <button onclick="processBulkAndShowSummary()" class="btn-secondary"><i class="fas fa-chart-bar"></i> Process + Show Summary</button>
      <button onclick="clearInput()" class="btn-danger"><i class="fas fa-times"></i> Clear Input</button>
    </div>
    <div class="note">
      <strong>Note:</strong> The tool will extract coach numbers like <code>06-PK-MA</code>, <code>01 MA-PK</code>, <code>103 CHA SWK</code>, <code>454-MTB-GPL-GBT</code> and add them as Jor/Bijor based on coach number parity. Closed trips (Seats 34 or more) are omitted from lists but saved separately.
    </div>
  </div>

  <div class="input-section">
    <h3><i class="fas fa-plus-circle"></i> Add Single Trip</h3>
    <input id="single" type="text" placeholder="e.g. SP 806-PK-MA 05:00 AM or 806-PK-MA" />
    <div class="input-actions">
      <button onclick="addSingle()" class="btn-primary"><i class="fas fa-plus"></i> Add Trip</button>
      <button onclick="addSingleAndShow()" class="btn-secondary"><i class="fas fa-eye"></i> Add + Show</button>
    </div>
  </div>
</div>

<script>
/* ---------- Initialize jsPDF ---------- */
const { jsPDF } = window.jspdf;

/* ---------- state ---------- */
const today = new Date().toISOString().split('T')[0];
let data = JSON.parse(localStorage.getItem('tripDataFinal')) || {};
let currentViewDate = today;

/* date picker init */
const datePicker = document.getElementById('datePicker');
const currentDateDisplay = document.getElementById('currentDateDisplay');
datePicker.value = currentViewDate;
datePicker.max = today;
currentDateDisplay.innerText = formatDateDisplay(currentViewDate);

/* status box */
const statusBox = document.getElementById('statusBox');
function showStatus(msg, type = 'info', duration = 3500) {
  statusBox.style.display = 'block';
  statusBox.className = `status-box ${type}`;
  statusBox.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${msg}`;
  
  clearTimeout(showStatus._t);
  showStatus._t = setTimeout(() => {
    statusBox.style.display = 'none';
  }, duration);
}

/* ---------- utility: format date ---------- */
function formatDateDisplay(dateStr) {
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  } catch(e) { return dateStr; }
}

/* ---------- extractor (more flexible) ---------- */
function extractTripCode(text) {
  if(!text) return null;
  text = text.trim();
  let hasSP = false;
  if(/^SP\s+/i.test(text)) {
    hasSP = true;
    text = text.replace(/^SP\s+/i, '').trim();
  }

  const m = text.match(/^(\d{1,4})(?:[\s\-\.]+([A-Z0-9][A-Z0-9\-\s\.]*)?)?/i);
  if(!m) return null;
  const number = m[1];
  let rest = m[2] || '';
  rest = rest.replace(/\./g, ' ').trim().replace(/\s+/g, '-').replace(/-+/g, '-').toUpperCase();
  const code = rest ? `${number}-${rest}` : `${number}`;
  return hasSP ? `SP ${code}` : code;
}

/* ---------- save helpers ---------- */
function save() { 
  localStorage.setItem('tripDataFinal', JSON.stringify(data)); 
}

function ensureDateBucket(date) {
  if(!data[date]) data[date] = { jor: [], bijor: [], closed: [] };
  else {
    if(!data[date].jor) data[date].jor = [];
    if(!data[date].bijor) data[date].bijor = [];
    if(!data[date].closed) data[date].closed = [];
  }
}

/* ---------- add logic ---------- */
function addTripToCurrentDate(text) {
  const code = extractTripCode(text);
  if(!code) return { ok: false, reason: 'no_code' };

  ensureDateBucket(currentViewDate);

  const numMatch = code.match(/\d+/);
  if(!numMatch) return { ok: false, reason: 'no_number' };
  const num = parseInt(numMatch[0], 10);
  const side = (num % 2 === 0) ? 'jor' : 'bijor';

  if(data[currentViewDate][side].includes(code)) {
    return { ok: false, reason: 'duplicate', code, side };
  }

  data[currentViewDate][side].push(code);
  save();
  render();
  return { ok: true, code, side };
}

function addClosedToCurrentDate(code) {
  if(!code) return { ok: false };
  ensureDateBucket(currentViewDate);
  if(!data[currentViewDate].closed.includes(code)) {
    data[currentViewDate].closed.push(code);
    save();
    return { ok: true };
  }
  return { ok: false, reason: 'duplicate' };
}

/* ---------- bulk processing ---------- */
function processBulk() {
  const raw = document.getElementById('bulk').value;
  if(!raw || raw.trim() === '') { 
    showStatus('Please paste some lines first', 'error'); 
    return; 
  }

  const parts = raw.split(/Coach No/i);
  let added = 0, duplicates = 0, errors = 0, omittedClosed = 0, parsed = 0;

  for(const seg of parts) {
    const s = seg.trim();
    if(!s) continue;

    const lines = s.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    if(lines.length === 0) continue;
    let coachCandidate = lines[0];

    coachCandidate = coachCandidate.replace(/\.+$/, '').trim();

    let seats = null;
    const seatsMatch1 = s.match(/Seats\s*[:\s]*\r?\n\s*(\d{1,3})/i);
    const seatsMatch2 = s.match(/Seats\s*[:\s]*([0-9]{1,3})/i);
    if(seatsMatch1) seats = parseInt(seatsMatch1[1], 10);
    else if(seatsMatch2) seats = parseInt(seatsMatch2[1], 10);

    const norm = extractTripCode(coachCandidate);
    if(!norm) {
      errors++;
      continue;
    }
    parsed++;

    if(seats !== null && seats >= 34) {
      addClosedToCurrentDate(norm);
      omittedClosed++;
      continue;
    }

    const res = addTripToCurrentDate(norm);
    if(res.ok) added++;
    else if(res.reason === 'duplicate') duplicates++;
    else errors++;
  }

  document.getElementById('bulk').value = '';
  showStatus(`Parsed ${parsed} coach lines — Added: ${added}, Duplicates: ${duplicates}, Omitted(closed): ${omittedClosed}, Ignored errors: ${errors}`, 'success');
}

function processBulkAndShowSummary() { 
  processBulk(); 
}

/* ---------- single add ---------- */
function addSingle() {
  const txt = document.getElementById('single').value.trim();
  if(!txt) { 
    showStatus('Enter a trip first', 'error'); 
    return; 
  }
  const res = addTripToCurrentDate(txt);
  if(res.ok) {
    document.getElementById('single').value = '';
    showStatus(`Added ${res.code} (${res.side})`, 'success');
  } else if(res.reason === 'duplicate') {
    showStatus(`${res.code} already exists (${res.side})`, 'error');
  } else {
    showStatus('Could not detect coach number', 'error');
  }
}

function addSingleAndShow() { 
  addSingle(); 
}

/* ---------- render ---------- */
function render() {
  currentDateDisplay.innerText = formatDateDisplay(currentViewDate);

  const jList = document.getElementById('jorList');
  const bList = document.getElementById('bijorList');

  const jArr = (data[currentViewDate] ? data[currentViewDate].jor.slice() : []).sort();
  const bArr = (data[currentViewDate] ? data[currentViewDate].bijor.slice() : []).sort();

  if(jArr.length === 0) {
    jList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-bus" style="color: #1976d2;"></i>
        <p>No jor trips for this date</p>
      </div>
    `;
  } else {
    jList.innerHTML = jArr.map((t, i) => `
      <div class="trip-item">
        <div class="serial-number">${i + 1}.</div>
        <div class="trip-code">${t}</div>
        <div style="color: #1976d2; font-weight: 600;">Jor</div>
      </div>
    `).join('');
  }

  if(bArr.length === 0) {
    bList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-bus-alt" style="color: #f57c00;"></i>
        <p>No bijor trips for this date</p>
      </div>
    `;
  } else {
    bList.innerHTML = bArr.map((t, i) => `
      <div class="trip-item">
        <div class="serial-number">${i + 1}.</div>
        <div class="trip-code">${t}</div>
        <div style="color: #f57c00; font-weight: 600;">Bijor</div>
      </div>
    `).join('');
  }

  document.getElementById('jorCount').innerText = jArr.length;
  document.getElementById('bijorCount').innerText = bArr.length;
  document.getElementById('totalCount').innerText = jArr.length + bArr.length;

  let all = 0;
  Object.keys(data).forEach(d => {
    all += (data[d].jor?.length || 0) + (data[d].bijor?.length || 0);
  });
  document.getElementById('allTimeCount').innerText = all;
}

/* ---------- copy helpers ---------- */
function fallbackCopyTextToClipboard(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try {
    document.execCommand('copy');
    document.body.removeChild(ta);
    return true;
  } catch(e) {
    document.body.removeChild(ta);
    return false;
  }
}

function copyText(text) {
  if(!text) return false;
  if(navigator.clipboard && navigator.clipboard.writeText) {
    return navigator.clipboard.writeText(text).then(() => true).catch(() => fallbackCopyTextToClipboard(text));
  } else {
    return Promise.resolve(fallbackCopyTextToClipboard(text));
  }
}

function copyList(type) {
  const arr = data[currentViewDate] ? data[currentViewDate][type] : [];
  if(!arr || arr.length === 0) { 
    showStatus('Nothing to copy', 'error'); 
    return; 
  }
  const text = arr.join('\n');
  copyText(text).then(ok => {
    if(ok) showStatus(`Copied ${arr.length} ${type} trips`, 'success');
    else showStatus('Copy failed — try selecting and copying manually', 'error');
  });
}

function copyAll() {
  const j = data[currentViewDate] ? data[currentViewDate].jor : [];
  const b = data[currentViewDate] ? data[currentViewDate].bijor : [];
  if((!j || j.length === 0) && (!b || b.length === 0)) { 
    showStatus('Nothing to copy', 'error'); 
    return; 
  }

  let out = '';
  if(j && j.length) out += 'JOR:\n' + j.join('\n') + '\n\n';
  if(b && b.length) out += 'BIJOR:\n' + b.join('\n');

  copyText(out).then(ok => {
    if(ok) showStatus('Copied Jor + Bijor', 'success');
    else showStatus('Copy failed — try selecting and copying manually', 'error');
  });
}

/* ---------- clear functions ---------- */
function clearList(type) {
  if(!data[currentViewDate] || !data[currentViewDate][type] || data[currentViewDate][type].length === 0) {
    showStatus(`No ${type} trips to clear`, 'error');
    return;
  }
  if(!confirm(`Clear all ${type} trips for ${currentViewDate}?`)) return;
  data[currentViewDate][type] = [];
  save(); 
  render(); 
  showStatus(`Cleared ${type} trips for ${currentViewDate}`, 'success');
}

function clearCurrentDate() {
  if(!data[currentViewDate] || ((data[currentViewDate].jor.length + data[currentViewDate].bijor.length + (data[currentViewDate].closed?.length || 0)) === 0)) {
    showStatus('No trips for this date to clear', 'error'); 
    return;
  }
  if(!confirm(`Clear ALL trips for ${currentViewDate}? This will remove ${ (data[currentViewDate].jor.length + data[currentViewDate].bijor.length + (data[currentViewDate].closed?.length || 0)) } trips.`)) return;
  delete data[currentViewDate];
  save(); 
  render(); 
  showStatus(`Cleared all trips for ${currentViewDate}`, 'success');
}

function clearAllData() {
  let total = 0, dates = Object.keys(data).length;
  Object.keys(data).forEach(d => {
    total += (data[d].jor?.length || 0) + (data[d].bijor?.length || 0) + (data[d].closed?.length || 0);
  });
  if(total === 0) { 
    showStatus('No data to clear', 'error'); 
    return; 
  }
  if(!confirm(`Clear ALL stored data? (${total} trips across ${dates} dates). This cannot be undone.`)) return;
  data = {};
  save(); 
  render(); 
  showStatus('All data cleared', 'success');
}

/* ---------- date navigation ---------- */
function goToToday() { 
  currentViewDate = today; 
  datePicker.value = today; 
  render(); 
  showStatus('Switched to today', 'success'); 
}

datePicker.addEventListener('change', () => {
  const selected = datePicker.value;
  if(!selected) return;
  if(selected > today) { 
    showStatus('Cannot select future date', 'error'); 
    datePicker.value = currentViewDate; 
    return; 
  }
  currentViewDate = selected;
  render();
});

/* ---------- Excel Export (Fixed) ---------- */
function exportToExcel() {
  const jorTrips = data[currentViewDate] ? data[currentViewDate].jor.slice().sort() : [];
  const bijorTrips = data[currentViewDate] ? data[currentViewDate].bijor.slice().sort() : [];
  
  if(jorTrips.length === 0 && bijorTrips.length === 0) {
    showStatus('No trips to export for this date', 'error');
    return;
  }

  try {
    // Prepare data for Excel
    const maxRows = Math.max(jorTrips.length, bijorTrips.length);
    const excelData = [];
    
    // Add header row
    excelData.push(['Serial No.', 'Jor Trips', 'Bijor Trips']);
    
    // Add data rows
    for(let i = 0; i < maxRows; i++) {
      const row = [
        i + 1,
        jorTrips[i] || '',
        bijorTrips[i] || ''
      ];
      excelData.push(row);
    }
    
    // Add summary row
    excelData.push(['', '', '']);
    excelData.push(['SUMMARY', '', '']);
    excelData.push(['Total Jor Trips:', jorTrips.length, '']);
    excelData.push(['Total Bijor Trips:', bijorTrips.length, '']);
    excelData.push(['Total Trips:', jorTrips.length + bijorTrips.length, '']);
    excelData.push(['Date:', currentViewDate, formatDateDisplay(currentViewDate)]);
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // Apply styling through column widths
    ws['!cols'] = [
      { wch: 12 }, // Serial No.
      { wch: 30 }, // Jor Trips
      { wch: 30 }  // Bijor Trips
    ];
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Bus Trips');
    
    // Generate Excel file - FIXED METHOD
    const fileName = `Bus_Trips_${currentViewDate}.xlsx`;
    
    // Use writeFile method which should trigger download
    XLSX.writeFile(wb, fileName);
    
    showStatus(`Excel file "${fileName}" is downloading...`, 'success', 5000);
  } catch (error) {
    console.error('Excel export error:', error);
    showStatus('Excel export failed. Please try again.', 'error');
  }
}

/* ---------- PDF Export (Fixed) ---------- */
function exportToPDF() {
  const jorTrips = data[currentViewDate] ? data[currentViewDate].jor.slice().sort() : [];
  const bijorTrips = data[currentViewDate] ? data[currentViewDate].bijor.slice().sort() : [];
  
  if(jorTrips.length === 0 && bijorTrips.length === 0) {
    showStatus('No trips to export for this date', 'error');
    return;
  }

  try {
    // Create PDF document
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });

    // Title
    doc.setFontSize(24);
    doc.setTextColor(25, 118, 210);
    doc.text('Bus Trip Report', 105, 20, { align: 'center' });
    
    // Subtitle
    doc.setFontSize(14);
    doc.setTextColor(100, 100, 100);
    doc.text('Bus Trip Hisab By Md Ohidul Islam', 105, 30, { align: 'center' });
    
    // Date information
    doc.setFontSize(12);
    doc.setTextColor(50, 50, 50);
    doc.text(`Date: ${currentViewDate} (${formatDateDisplay(currentViewDate)})`, 105, 40, { align: 'center' });
    
    // Summary statistics
    doc.setFontSize(11);
    doc.setTextColor(25, 118, 210);
    doc.text('Summary Statistics:', 20, 55);
    
    doc.setFontSize(10);
    doc.setTextColor(80, 80, 80);
    doc.text(`Total Jor Trips: ${jorTrips.length}`, 30, 62);
    doc.text(`Total Bijor Trips: ${bijorTrips.length}`, 30, 67);
    doc.text(`Total Trips: ${jorTrips.length + bijorTrips.length}`, 30, 72);
    
    // Prepare table data
    const tableData = [];
    const maxRows = Math.max(jorTrips.length, bijorTrips.length);
    
    for(let i = 0; i < maxRows; i++) {
      tableData.push([
        i + 1,
        jorTrips[i] || '',
        bijorTrips[i] || ''
      ]);
    }
    
    // Create table
    doc.autoTable({
      startY: 80,
      head: [['Serial No.', 'Jor Trips', 'Bijor Trips']],
      body: tableData,
      theme: 'striped',
      headStyles: {
        fillColor: [25, 118, 210],
        textColor: [255, 255, 255],
        fontSize: 11,
        fontStyle: 'bold'
      },
      columnStyles: {
        0: { cellWidth: 25, halign: 'center' },
        1: { cellWidth: 80, fillColor: [232, 244, 253] },
        2: { cellWidth: 80, fillColor: [255, 243, 224] }
      },
      styles: {
        fontSize: 10,
        cellPadding: 4,
        overflow: 'linebreak'
      },
      didParseCell: function(data) {
        if(data.section === 'body') {
          if(data.column.index === 1 && data.cell.raw) {
            data.cell.styles.fillColor = [232, 244, 253];
          }
          if(data.column.index === 2 && data.cell.raw) {
            data.cell.styles.fillColor = [255, 243, 224];
          }
        }
      }
    });
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text(`Page ${i} of ${pageCount}`, 105, 287, { align: 'center' });
      doc.text(`Generated on: ${new Date().toLocaleString()}`, 105, 292, { align: 'center' });
    }
    
    // Save PDF - FIXED METHOD
    const fileName = `Bus_Trips_${currentViewDate}.pdf`;
    
    // Save the PDF
    doc.save(fileName);
    
    showStatus(`PDF file "${fileName}" is downloading...`, 'success', 5000);
  } catch (error) {
    console.error('PDF export error:', error);
    showStatus('PDF export failed. Please try again.', 'error');
  }
}

/* ---------- Alternative Download Methods ---------- */
function downloadFile(content, fileName, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
}

/* ---------- misc helpers ---------- */
function clearInput() { 
  document.getElementById('bulk').value = ''; 
  document.getElementById('single').value = ''; 
  showStatus('Inputs cleared', 'success'); 
}

/* ---------- initialize ---------- */
(function init() {
  datePicker.value = currentViewDate;
  render();
})();
</script>
</body>
</html>
